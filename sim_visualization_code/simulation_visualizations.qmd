---
title: "ChIP-Seq Simulation Visualizations: Analyzing False Discovery Rate, Power, and Absolute Size Factor Ratios, Relative to the Oracle"
format:
  html:
    toc: true
    toc-depth: 3
    toc-expand: true
    number-sections: true
knitr: 
  opts_chunk:
    fig.align: center
    out.width: "110%"
    message: false
    warning: false
---

## Loading and Wrangling the Simulation Data

```{r loading tidyverse and data}
library(tidyverse)
shape_palette <- c(16, 17, 15, 18, 3, 4, 8, 7, 9)


TTT_2_rep <- read_csv("simulation_data/TTT_2_rep.csv")
TTF_2_rep <- read_csv("simulation_data/TTF_2_rep.csv")
FTT_2_rep <- read_csv("simulation_data/FTT_2_rep.csv")
TFT_2_rep <- read_csv("simulation_data/TFT_2_rep.csv")
FFT_2_rep <- read_csv("simulation_data/FFT_2_rep.csv")
FTF_2_rep <- read_csv("simulation_data/FTF_2_rep.csv")
TFF_2_rep <- read.csv("simulation_data/TFF_2_rep.csv")
FFF_2_rep <- read.csv("simulation_data/FFF_2_rep.csv")

TTT_3_rep <- read_csv("simulation_data/TTT_3_rep.csv")
TTF_3_rep <- read_csv("simulation_data/TTF_3_rep.csv")
FTT_3_rep <- read_csv("simulation_data/FTT_3_rep.csv")
TFT_3_rep <- read_csv("simulation_data/TFT_3_rep.csv")
TFF_3_rep <- read_csv("simulation_data/TFF_3_rep.csv")
FTF_3_rep <- read_csv("simulation_data/FTF_3_rep.csv")
FFT_3_rep <- read_csv("simulation_data/FFT_3_rep.csv")
FFF_3_rep <- read_csv("simulation_data/FFF_3_rep.csv")
```

```{r combining and wrangling the data}
data_2_rep <- TTT_2_rep |>
  rbind(TTF_2_rep, FTT_2_rep, TFT_2_rep, FTF_2_rep, FFT_2_rep, TFF_2_rep, FFF_2_rep) |>
  mutate(technique = case_when(
    technique == "LIB_BINS" ~ "Library Size (Background Bins)",
    technique == "LIB_PEAKS" ~ "Library Size (Reads in Peaks)",
    technique == "RLE_BINS" ~ "RLE (Background Bins)",
    technique == "RLE_PEAKS" ~ "RLE (Reads in Peaks)",
    technique == "TMM_BINS" ~ "TMM (Background Bins)",
    technique == "TMM_PEAKS" ~ "TMM (Reads in Peaks)",
    technique == "DBA_NORM_OFFSETS_ADJUST" ~ "Loess Adjusted Fit (Reads in Peaks)",
    TRUE ~ technique
  )) |>
  mutate(technique = fct_relevel(technique, "Loess Adjusted Fit (Reads in Peaks)", after = 8),
         technique = fct_relevel(technique, "MAnorm2", after = 8),
         technique = fct_relevel(technique, "Oracle"),
         symm = if_else(symmetry == TRUE, "Balanced",
                        "Unbalanced"),
         symm = fct_relevel(symm, "Balanced"),
         dna = if_else(equal.DNA.bind == TRUE, "Equal Occupancy", 
                       "Unequal Occupancy"),
         back = if_else(constant.background == TRUE, "Equal Background",
                        "Unequal Background")) 

data_3_rep <- TTT_3_rep |>
  rbind(TTF_3_rep, FTT_3_rep, TFT_3_rep, FFT_3_rep, TFF_3_rep, FTF_3_rep, FFF_3_rep) |>
  mutate(technique = case_when(
    technique == "LIB_BINS" ~ "Library Size (Background Bins)",
    technique == "LIB_PEAKS" ~ "Library Size (Reads in Peaks)",
    technique == "RLE_BINS" ~ "RLE (Background Bins)",
    technique == "RLE_PEAKS" ~ "RLE (Reads in Peaks)",
    technique == "TMM_BINS" ~ "TMM (Background Bins)",
    technique == "TMM_PEAKS" ~ "TMM (Reads in Peaks)",
    technique == "DBA_NORM_OFFSETS_ADJUST" ~ "Loess Adjusted Fit (Reads in Peaks)",
    TRUE ~ technique
  )) |>
  mutate(technique = fct_relevel(technique, "Loess Adjusted Fit (Reads in Peaks)", after = 8),
         technique = fct_relevel(technique, "MAnorm2", after = 8),
         technique = fct_relevel(technique, "Oracle"),
         symm = if_else(symmetry == TRUE, "Balanced",
                        "Unbalanced"),
         symm = fct_relevel(symm, "Balanced"),
         dna = if_else(equal.DNA.bind == TRUE, "Equal Occupancy", 
                       "Unequal Occupancy"),
         back = if_else(constant.background == TRUE, "Equal Background",
                        "Unequal Background")) 
```

```{r thresholds dataframe}
thresholds <- data.frame(metric = c("Average Empirical FDR","Average Power", 
                                    "Average Absolute\nSize Factor Ratio\nRelative to the Oracle"),
                         yint = c(0.05, 1, 1)) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle"))
```

## Overall Average False Discovery Rate and Power

### Average False Discovery Rate

```{r all FDR -- 2 rep}
data_2_rep |>
  group_by(prop.do, technique, symm, dna, back, FDR.threshold) |>
  summarize(avg_FDR = mean(FDR, na.rm = TRUE)) |>
  mutate(avg_FDR_jittered = jitter(avg_FDR)) |>
  ggplot(aes(x = prop.do, y = avg_FDR_jittered))+
  geom_hline(aes(yintercept = FDR.threshold), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average Empirical FDR")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"),
         shape = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))

ggsave("../visualization_outputs/all_FDR_2_rep.pdf", bg = "white", dpi = 1500, width = 15, height = 8, units = "in")
```

```{r all FDR -- 3 rep}
data_3_rep |>
  group_by(prop.do, technique, symm, dna, back, FDR.threshold) |>
  summarize(avg_FDR = mean(FDR, na.rm = TRUE)) |>
  ggplot(aes(x = prop.do, y = avg_FDR))+
  geom_hline(aes(yintercept = FDR.threshold), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average Empirical FDR")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"),
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))

ggsave("../visualization_outputs/all_FDR_3_rep.pdf", bg = "white", dpi = 1500, width = 15, height = 8, units = "in")
```
### Average Power

```{r all power -- 2 rep}
data_2_rep  |>
  group_by(prop.do, technique, symm, dna, back, FDR.threshold) |>
  summarize(avg_FDR = mean(FDR, na.rm = TRUE)) |>
  ggplot(aes(x = prop.do, y = avg_FDR))+
  geom_hline(aes(yintercept = FDR.threshold), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average False Discovery Rate")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"),
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))


ggsave("../visualization_outputs/all_power_2_rep.pdf", bg = "white", dpi = 2000, width = 15, height = 8, units = "in")
```


```{r all power -- 3 rep}
data_3_rep |>
  filter(technique != 'MAnorm2') |>
  group_by(prop.do, technique, symm, dna, back) |>
  summarize(avg_power = mean(true_positives/(true_positives + false_negatives),
                             na.rm = TRUE)) |>
  ggplot(aes(x = prop.do, y = avg_power))+
  geom_hline(yintercept = 1, linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average Power")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))

ggsave("../visualization_outputs/all_power_3_rep.pdf", bg = "white", dpi = 1500, width = 15, height = 8, units = "in")
```

### Average Absolute Size Factor Ratio, Relative to the Oracle Data

```{r dataframe of the Oracle size factors -- 3 rep}
Oracle_Final_3 <- data_3_rep |>
  filter(technique == "Oracle") |>
  select(symm, dna, back, prop.do, it, contains("rep")) |>
  pivot_longer(contains("rep"), names_to = "replicate", values_to = "oracle_sizefactor")
```

```{r dataframe of the Oracle size factors -- 2 rep}
Oracle_Final_2 <- data_2_rep |>
  filter(technique == "Oracle") |>
  select(symm, dna, back, prop.do, it, contains("rep")) |>
  pivot_longer(contains("rep"), names_to = "replicate", values_to = "oracle_sizefactor")
```

```{r dataframes comparing size factors}
sizefactors_rel_oracle_3 <- data_3_rep |>
  select(technique, symm, dna, back,
         prop.do, it, contains("rep"))|>
  filter(!(technique %in% c("MAnorm2", 	"DBA_NORM_OFFSETS_ADJUST"))) |>
  pivot_longer(contains("rep"), names_to = "replicate", values_to = "technique_sizefactor") |>
  left_join(Oracle_Final_3, 
            by = c("symm", "dna", "back", "prop.do", "it", "replicate")) |>
   mutate(sizefactor_ratio = if_else(technique_sizefactor/oracle_sizefactor >= 1,
                                     technique_sizefactor/oracle_sizefactor,
                                     oracle_sizefactor/technique_sizefactor)) |>
  group_by(technique, symm, dna, back, prop.do) |>
  summarize(mean_sizefactor_ratio_prop.do = mean(sizefactor_ratio)) 

sizefactors_rel_oracle_2 <- data_2_rep |>
  select(technique, symm, dna, back,
         prop.do, it, contains("rep"))|>
  filter(!(technique %in% c("MAnorm2", 	"DBA_NORM_OFFSETS_ADJUST"))) |>
  pivot_longer(contains("rep"), names_to = "replicate", values_to = "technique_sizefactor") |>
  left_join(Oracle_Final_2, 
            by = c("symm", "dna", "back", "prop.do", "it", "replicate")) |>
   mutate(sizefactor_ratio = if_else(technique_sizefactor/oracle_sizefactor >= 1,
                                     technique_sizefactor/oracle_sizefactor,
                                     oracle_sizefactor/technique_sizefactor)) |>
  group_by(technique, symm, dna, back, prop.do) |>
  summarize(mean_sizefactor_ratio_prop.do = mean(sizefactor_ratio)) 
```

## Primary Results Panels

### TTT Panels

```{r TTT 3 rep}
data_3_rep |>
  filter(symmetry & equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: All Technical Conditions Met")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))

ggsave("../visualization_outputs/TTT-3-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

```{r TTT 2 rep}
data_2_rep |>
filter(symmetry & equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: All Technical Conditions Met")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))

ggsave("../visualization_outputs/TTT-2-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

### FTT Panels

```{r FTT 3 rep}
data_3_rep |>
 filter(!symmetry & equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: Unbalanced Differential DNA Occupancy")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))

ggsave("../visualization_outputs/FTT-3-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

```{r 2 FTT 2 rep}
data_2_rep |>
 filter(!symmetry & equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: Asymmetric Differential DNA Occupancy")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))


ggsave("../visualization_outputs/FTT-2-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

### TFT Panels

```{r TFT 3 rep}
data_3_rep |>
 filter(symmetry & !equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: Unequal Total DNA Occupancy")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))

ggsave("../visualization_outputs/TFT-3-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

```{r TFT 2 rep}
data_2_rep |>
 filter(symmetry & !equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: Unequal Total DNA Occupancy")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))


ggsave("../visualization_outputs/TFT-2-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

### TTF Panels

```{r TTF 3 rep}
data_3_rep |>
 filter(symmetry & equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique, linetype = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         linetype = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: Unequal Background Binding")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))

ggsave("../visualization_outputs/TTF-3-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```

```{r TTF 2 rep}
data_2_rep |>
 filter(symmetry & equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint), linetype = "dashed")+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"))+
  ggtitle("Simulation Results: Unequal Background Binding")+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 18))


ggsave("../visualization_outputs/TTF-2-rep.pdf", bg = "white", dpi = 1500, width = 13, height = 7, units = "in")
```


# Extras

## 95% Confidence Intervals of Average False Discovery Rate and Power

```{r CI FDR -- 2 rep}
data_2_rep |>
  group_by(prop.do, technique, symm, dna, back, FDR.threshold) |>
  summarize(avg_FDR = mean(FDR, na.rm = TRUE),
            se_FDR = sd(FDR, na.rm = TRUE)/sqrt(n())) |>
  ggplot(aes(x = prop.do, y = avg_FDR))+
  geom_hline(aes(yintercept = FDR.threshold), linetype = "dashed")+
  geom_ribbon(aes(ymin = avg_FDR - 2*se_FDR, ymax = avg_FDR + 2*se_FDR,
                  fill = technique), alpha = 0.1)+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average False Discovery Rate")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  grafify::scale_fill_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         fill = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))

ggsave("../visualization_outputs/CI_FDR_2_rep.pdf", bg = "white", dpi = 1500, width = 15, height = 8, units = "in")
```

```{r CI power -- 2 rep}
data_2_rep  |>
  group_by(prop.do, technique, symm, dna, back) |>
  summarize(avg_power = mean(true_positives/(true_positives + false_negatives), na.rm = TRUE),
            se_power = sd(true_positives/(true_positives + false_negatives),
                           na.rm = TRUE)/sqrt(n())) |>
  ggplot(aes(x = prop.do, y = avg_power))+
  geom_hline(yintercept = 1, linetype = "dashed")+
  geom_ribbon(aes(ymin = avg_power - 2*se_power,
                  ymax = avg_power + 2*se_power, fill = technique),
              alpha = 0.1)+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average False Discovery Rate")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  grafify::scale_fill_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         fill = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))


ggsave("../visualization_outputs/CI_power_2_rep.pdf", bg = "white", dpi = 2000, width = 15, height = 8, units = "in")
```

```{r CI FDR -- 3 rep}
data_3_rep |>
  group_by(prop.do, technique, symm, dna, back, FDR.threshold) |>
  summarize(avg_FDR = mean(FDR, na.rm = TRUE),
            se_FDR = sd(FDR, na.rm = TRUE)/sqrt(n())) |>
  ggplot(aes(x = prop.do, y = avg_FDR))+
  geom_hline(aes(yintercept = FDR.threshold), linetype = "dashed")+
  geom_ribbon(aes(ymin = avg_FDR - 2*se_FDR, ymax = avg_FDR + 2*se_FDR,
                  fill = technique), alpha = 0.1)+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average False Discovery Rate")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  grafify::scale_fill_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         fill = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))

ggsave("../visualization_outputs/CI_FDR_3_rep.pdf", bg = "white", dpi = 1500, width = 15, height = 8, units = "in")
```

```{r CI power -- 3 rep}
data_3_rep  |>
  group_by(prop.do, technique, symm, dna, back) |>
  summarize(avg_power = mean(true_positives/(true_positives + false_negatives), na.rm = TRUE),
            se_power = sd(true_positives/(true_positives + false_negatives),
                           na.rm = TRUE)/sqrt(n())) |>
  ggplot(aes(x = prop.do, y = avg_power))+
  geom_hline(yintercept = 1, linetype = "dashed")+
  geom_ribbon(aes(ymin = avg_power - 2*se_power,
                  ymax = avg_power + 2*se_power, fill = technique),
              alpha = 0.1)+
  geom_point(aes(color = technique, shape = technique), size = 1.5)+
  geom_line(aes(color = technique), size = .8)+
  xlab("Proportion of Peaks with Differential DNA Occupancy")+
  ylab("Average False Discovery Rate")+
  facet_grid(back ~ symm + dna)+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  grafify::scale_fill_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"),
         fill = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black", size = 14),
        legend.title = element_text(face = "bold", size = 14),
        axis.title = element_text(face = "bold", size = 14),
        panel.background = element_rect(color = "black"),
        legend.key = element_blank(),
        strip.background = element_rect(color = "black"),
        strip.text = element_text(color = "black", size = 14, face = "bold"),
        legend.text = element_text(size = 14))

ggsave("../visualization_outputs/CI_power_3_rep.pdf", bg = "white", dpi = 1500, width = 15, height = 8, units = "in")
```

## Additional Results Panels

### FFT Panels

```{r FFT for 3 and 2 rep}
#| message: false
#| warning: false

data_3_rep |>
  filter(!symmetry & !equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/FFT-3-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")

data_2_rep |>
  filter(!symmetry & !equal.DNA.bind & constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio,\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/FFT-2-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")

```

### FTF Panels

```{r FTF for 3 and 2 rep}
data_3_rep |>
  filter(!symmetry & equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/FTF-3-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")

data_2_rep |>
  filter(!symmetry & equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/FTF-2-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")
```

### TFF Panels

```{r TFF for 3 and 2 rep}
data_3_rep |>
  filter(symmetry & !equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/TFF-3-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5)

data_2_rep |>
  filter(symmetry & !equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio,\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/TFF-2-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")
```

### FFF Panels

```{r FFF for 3 and 2 rep}
data_3_rep |>
  filter(!symmetry & !equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_3,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         linetype = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/FFF-3-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")

data_2_rep |>
  filter(!symmetry & !equal.DNA.bind & !constant.background) |>
  mutate(power = true_positives/(true_positives + false_negatives)) |>
  group_by(technique, symmetry, symm, equal.DNA.bind, dna, 
           constant.background, back, prop.do) |>
  summarise(avg_power = mean(power), avg_FDR = mean(FDR))  |>
  ungroup() |>
  left_join(sizefactors_rel_oracle_2,
            by = c("technique", "symm", "dna",
                   "back", "prop.do")) |>
  pivot_longer(avg_power:mean_sizefactor_ratio_prop.do, 
               names_to = "metric", values_to = "values") |>
  mutate(metric = case_when(
    metric == "avg_power" ~ "Average Power",
    metric == "avg_FDR" ~ "Average Empirical FDR",
    metric == "mean_sizefactor_ratio_prop.do" ~ "Average Absolute\nSize Factor Ratio\nRelative to the Oracle",
    TRUE ~ metric
  )) |>
  mutate(metric = fct_relevel(metric, "Average Absolute\nSize Factor Ratio\nRelative to the Oracle", after = Inf)) |>
  ggplot(aes(x = prop.do, y = values, color = technique))+
  geom_hline(data = thresholds, aes(yintercept = yint))+
  geom_point(size = 0.5)+
  geom_line()+
  facet_wrap(~metric, scales = "free")+
  grafify::scale_color_grafify(ColSeq = FALSE, reverse = TRUE)+
  scale_shape_manual(values = shape_palette) +
  labs(y = "", x = "Proportion of Peaks with Differential DNA Occupancy")+
  guides(color = guide_legend(title = "Technique"), 
         shape = guide_legend(title = "Technique"))+
  theme_bw()+
  theme(text = element_text(color = "black"),
        axis.text = element_text(color = "black"),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(face = "bold"),
        axis.title = element_text(face = "bold"))

ggsave("../visualization_outputs/FFF-2-rep.pdf", bg = "white", dpi = 1500, width = 9, height = 5, units = "in")

```